/*
 * DataViewer library
 * Copyright 2014-2017 Geologische Bundesanstalt
 * Authors: Arno Kaimbacher
 * All Rights Reserved.
 * Use, reproduction, distribution, and modification of this code is subject to the terms and
 * conditions of the MIT license, available at http://www.opensource.org/licenses/mit-license.php
 *
 */

/*
 * DataViewer library
 * Copyright 2014-2017
 * Authors: Arno Kaimbacher
 * All Rights Reserved.
 * Use, reproduction, distribution, and modification of this code is subject to the terms and
 * conditions of the MIT license, available at http://www.opensource.org/licenses/mit-license.php
 *
 */

function _urlParam(e,t){var r=new RegExp("[\\?&]"+e+"=([^&#]*)").exec(t);return null===r?null:r[1]||0}define("helper/logger",["toastr"],function(e){return{error:function(t,r){r&&(e.options={closeButton:!0,debug:!1,positionClass:"toast-bottom-full-width",onclick:null,showDuration:"300",hideDuration:"1000",timeOut:"300000",extendedTimeOut:"1000",showEasing:"swing",hideEasing:"linear",showMethod:"fadeIn",hideMethod:"fadeOut"},e.error(t)),console.error(t)},info:function(t,r){r&&(e.options={closeButton:!1,debug:!1,positionClass:"toast-bottom-right",onclick:null,showDuration:"300",hideDuration:"1000",timeOut:"5000",extendedTimeOut:"1000",showEasing:"swing",hideEasing:"linear",showMethod:"fadeIn",hideMethod:"fadeOut"},e.info(t)),console.info(t)},warning:function(t,r){r&&(e.options={closeButton:!1,debug:!1,positionClass:"toast-bottom-right",onclick:null,showDuration:"200",hideDuration:"1000",timeOut:"5000",extendedTimeOut:"1000",showEasing:"swing",hideEasing:"linear",showMethod:"fadeIn",hideMethod:"fadeOut"},e.warning(t)),console.warn(t)},success:function(t,r){r&&(e.options={closeButton:!1,debug:!1,positionClass:"toast-bottom-right",onclick:null,showDuration:"300",hideDuration:"1000",timeOut:"5000",extendedTimeOut:"1000",showEasing:"swing",hideEasing:"linear",showMethod:"fadeIn",hideMethod:"fadeOut"},e.success(t)),console.info(t)}}}),define("plugins/Request",["leaflet","helper/logger"],function(e,t){"use strict";var r=0;window._Callbacks={};var i=function(e){var t="";e.f=e.f||"json";for(var r in e)if(e.hasOwnProperty(r)){var i,o=e[r],n=Object.prototype.toString.call(o);t.length&&(t+="&"),i="[object Array]"===n?"[object Object]"===Object.prototype.toString.call(o[0])?JSON.stringify(o):o.join(","):"[object Object]"===n?JSON.stringify(o):"[object Date]"===n?o.valueOf():o,t+=encodeURIComponent(r)+"="+encodeURIComponent(i)}return t},o=function(e,t){var r=new XMLHttpRequest;return r.onerror=function(r){e.call(t,{error:{code:500,message:"XMLHttpRequest error: "+r}},null)},r.onreadystatechange=function(){var i,o;if(4===r.readyState){try{i=JSON.parse(r.responseText)}catch(e){i=null,o={code:500,message:"Could not parse response as JSON."}}!o&&i.error&&(o=i.error,i=null),e.call(t,o,i)}},r};return{supportCors:window.XMLHttpRequest&&"withCredentials"in new XMLHttpRequest,request:function(e,r,n,a){var s=i(r),l=o(n,a),u=(e+"?"+s).length;if(u<1900&&this.supportCors)l.open("GET",e+"?"+s),l.send(null);else if(u>=1900&&this.supportCors)l.open("POST",e),l.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),l.send(s);else{if(u<=1900&&!this.supportCors)return this.get.JSONP(e,r,n,a);if(console&&console.warn)return t.warning("a request to "+e+" was longer then 2000 characters and this browser cannot make a cross-domain post request. Please use a proxy http://esri.github.io/esri-leaflet/api-reference/request.html",!0),console.warn("a request to "+e+" was longer then 2000 characters and this browser cannot make a cross-domain post request. Please use a proxy http://esri.github.io/esri-leaflet/api-reference/request.html"),l.onerror()}return l},get:{JSONP:function(t,o,n,a){var s="c"+r;o.callback="window._Callbacks."+s;var l=e.DomUtil.create("script",null,document.body);return l.type="text/javascript",l.src=t+"?"+i(o),l.id=s,window._Callbacks[s]=function(e){if(!0!==window._Callbacks[s]){var t,r=Object.prototype.toString.call(e);"[object Object]"!==r&&"[object Array]"!==r&&(t={error:{code:500,message:"Expected array or object as JSONP response"}},e=null),!t&&e.error&&(t=e,e=null),n.call(a,t,e),window._Callbacks[s]=!0}},r++,{id:s,url:l.src,abort:function(){window._Callbacks._callback[s]({code:0,message:"Request aborted."})}}}}}}),define("plugins/DynamicMapLayer",["leaflet","plugins/Request"],function(e,t){return e.Class.extend({includes:e.Mixin.Events,options:{updateInterval:150,layers:!1,layerDefs:!1,timeOptions:!1,format:"png24",transparent:!0,opacity:1,position:"front"},initialize:function(t,r){r=r||{},r.url=this._cleanUrl(t),e.Util.setOptions(this,r)},getLayers:function(){return this.options.layers},setLayers:function(e){return this.options.layers=e,this._update()},getLayerDefs:function(){return this.options.layerDefs},setLayerDefs:function(e){this.options.layerDefs=e,this._update()},bringToFront:function(){this.options.position="front",this._currentImage&&this._currentImage.bringToFront()},bringToBack:function(){this.options.position="back",this._currentImage&&this._currentImage.bringToBack()},reset:function(){this._reset()},show:function(){this._image.style.display="block",this._image.style.visibility="visible"},hide:function(){this._image.style.display="none"},isVisible:function(){return"block"===this._image.style.display},onAdd:function(t){if(this._map=t,this._update=e.Util.limitExecByInterval(this._update,this.options.updateInterval,this),t.options.crs&&t.options.crs.code){var r=t.options.crs.code.split(":")[1];this.options.bboxSR=r,this.options.imageSR=r}t.on("moveend",this._update,this),this._currentImage&&this._currentImage._bounds.equals(this._map.getBounds())?t.addLayer(this._currentImage):this._currentImage&&(this._map.removeLayer(this._currentImage),this._currentImage=null),this._update()},onRemove:function(){this._currentImage&&this._map.removeLayer(this._currentImage),this._popup&&(this._map.off("click",this._getPopupData,this),this._map.off("dblclick",this._resetPopupState,this)),this._map.off("moveend",this._update,this),this._map=null},addTo:function(e){return e.addLayer(this)},_cleanUrl:function(e){return e=e.replace(/\s\s*/g,""),"/"!==e[e.length-1]&&(e+="/"),e},_buildExportParams:function(){var e=this._map.getBounds(),t=this._map.getSize(),r=this._map.options.crs.project(e._northEast),i=this._map.options.crs.project(e._southWest),o={bbox:[i.x,i.y,r.x,r.y].join(","),size:t.x+","+t.y,dpi:96,format:this.options.format,transparent:this.options.transparent,bboxSR:this.options.bboxSR,imageSR:this.options.imageSR};return this.options.layers&&(o.layers="show:"+this.options.layers.join(",")),this.options.layerDefs&&(o.layerDefs=JSON.stringify(this.options.layerDefs)),this.options.timeOptions&&(o.timeOptions=JSON.stringify(this.options.timeOptions)),this.options.from&&this.options.to&&(o.time=this.options.from.valueOf()+","+this.options.to.valueOf()),o},_requestExport:function(e,r){t.request(this.options.url+"export",e,function(e,t){e?console.log(e.message):this._renderImage(t.href,r)},this)},_jsonpQueryArcGIS:function(e,t){var r=$.extend(e,{f:"json"});$.ajax({url:this.options.url+"export",type:"get",dataType:"jsonp",context:this,headers:{accept:"image/png"},data:r}).done(function(e){this._renderImage(e.href,t)}).fail(function(){})},_postQueryArcGIS:function(e,t){var r=$.extend(e,{f:"json"});$.ajax({url:this.options.url+"export",type:"post",crossDomain:!0,dataType:"json",contentType:"application/x-www-form-urlencoded",context:this,headers:{accept:"image/png"},data:r}).done(function(e){this._renderImage(e.href,t)}).fail(function(){})},_renderImage:function(t,r){if(this._map){new e.ImageOverlay(t,r,{opacity:0}).addTo(this._map).once("load",function(e){var t=e.target,i=this._currentImage;t._bounds.equals(r)?(this._currentImage=t,"front"===this.options.position?this.bringToFront():this.bringToBack(),this._map&&this._currentImage._map?this._currentImage.setOpacity(this.options.opacity):this._currentImage._map.removeLayer(this._currentImage),i&&this._map&&this._map.removeLayer(i),i&&i._map&&i._map.removeLayer(i)):this._map.removeLayer(t),this.fire("load",{bounds:r})},this),this.fire("loading",{bounds:r})}},_update:function(){var e,t,r;this._map&&(e=this._map.getZoom(),t=this._map.getBounds(),this._animatingZoom||this._map._panTransition&&this._map._panTransition._inProgress||e>this.options.maxZoom||e<this.options.minZoom||(r=this._buildExportParams(),this._requestExport(r,t)))},_reset:function(){this._image&&this._map.getPanes().mapPane.removeChild(this._image),this._initImage(),this._updateLayer()}})}),define("plugins/HomeButton",["leaflet","jquery","helper/logger"],function(e,t,r){"use strict";return e.Control.extend({_options:{position:"topright",homeText:"+",homeTitle:"Home Extent",visible:!0},initialize:function(t){e.Util.extend(this._options,t),this.map={},this.visible=this._options.visible,this.home=this._options.home},onAdd:function(t){if(!this.map)return void r.warning("HomeButton::map required",!0);this.map=t;var i=this._container=e.DomUtil.create("div","leaflet-control-home");return this._homeButton=this._createButton("",this._options.homeTitle,"leaflet-control-home-do",i,this._goHome,this),this._init(),i},_init:function(){this._visible(),this.home||(this.home=this.map.getBounds()),this.loaded=!0},_visible:function(){!0===this.visible?t(this._container).css("display","block"):t(this._container).css("display","none")},_goHome:function(){this._exitFired=!1;var t=e.latLngBounds(this._options.home._southWest,this._options.home._northEast);this.map.fitBounds(t)},_createButton:function(t,r,i,o,n,a){var s=e.DomUtil.create("a",i,o);s.innerHTML=t,s.href="#",s.title=r;var l=e.DomEvent.stopPropagation;return e.DomEvent.on(s,"click",l).on(s,"mousedown",l).on(s,"dblclick",l).on(s,"click",e.DomEvent.preventDefault).on(s,"click",n,a),s}})}),define("plugins/MyZoom",["leaflet"],function(e){return e.Control.extend({options:{position:"topright",zoomInText:"+",zoomInTitle:"Zoom in",zoomOutText:"-",zoomOutTitle:"Zoom out"},onAdd:function(t){var r="my-leaflet-control-zoom",i=e.DomUtil.create("div",r);return this._map=t,this._zoomInButton=this._createButton("",this.options.zoomInTitle,r+"-in",i,this._zoomIn,this),this._zoomOutButton=this._createButton("",this.options.zoomOutTitle,r+"-out",i,this._zoomOut,this),this._updateDisabled(),t.on("zoomend zoomlevelschange",this._updateDisabled,this),i},onRemove:function(e){e.off("zoomend zoomlevelschange",this._updateDisabled,this)},_zoomIn:function(e){this._map.zoomIn(e.shiftKey?3:1)},_zoomOut:function(e){this._map.zoomOut(e.shiftKey?3:1)},_createButton:function(t,r,i,o,n,a){var s=e.DomUtil.create("a",i,o);s.innerHTML="<span>"+t+"</span>",s.href="#",s.title=r;var l=e.DomEvent.stopPropagation;return e.DomEvent.on(s,"click",l).on(s,"mousedown",l).on(s,"dblclick",l).on(s,"click",e.DomEvent.preventDefault).on(s,"click",n,a).on(s,"click",this._refocusOnMap,a),s},_updateDisabled:function(){var t=this._map,r="leaflet-disabled";e.DomUtil.removeClass(this._zoomInButton,r),e.DomUtil.removeClass(this._zoomOutButton,r),t._zoom===t.getMinZoom()&&e.DomUtil.addClass(this._zoomOutButton,r),t._zoom===t.getMaxZoom()&&e.DomUtil.addClass(this._zoomInButton,r)}})}),define("app/map2",["leaflet","helper/logger","jquery","plugins/DynamicMapLayer","plugins/HomeButton","plugins/MyZoom","plugins/Request"],function(e,t,r,i,o,n,a){"use strict";return function(s){var l,u,c,p=this;p.map=null,p.LID_XHR=null,p.LID_POLY_XHR=null,p.LID_POLY_XHR2=null,p.setHomeExtent=function(){if(null!==p.map){var t=e.latLng(46.5,9.9),r=e.latLng(48.9,16.9),i=e.latLngBounds(t,r);p.map.fitBounds(i)}},p.init=function(){var t;p.map=t=e.map(s,{zoomControl:!1,attributionControl:!1,worldCopyJump:!1,zoomAnimation:!e.Browser.ie}),e.control.attribution({position:"bottomright",prefix:!1}).addTo(t);var r=e.latLng(46.5,9.9),a=e.latLng(48.9,16.9),f=e.latLngBounds(r,a);t.fitBounds(f),new o({home:{_southWest:{lat:46.5,lng:9.9},_northEast:{lat:48.9,lng:16.9}}}).addTo(t),(new n).addTo(t);var m=e.latLng(46.35877,8.782379),g=e.latLng(49.037872,17.189532),v=e.latLngBounds(m,g),b=e.tileLayer("https://{s}.wien.gv.at/basemap/bmapgrau/normal/google3857/{z}/{y}/{x}.png",{attribution:"www.basemap.at",subdomains:["maps","maps1","maps2","maps3"],continuousWorld:!1,detectRetina:!1,bounds:v});b.addTo(t);var w=new e.tileLayer.wms("http://gisgba.geologie.ac.at/arcgis/services/image/AT_GBA_MGK500/ImageServer/WMSServer",{layers:"0",version:"1.3.0",format:"image/png",transparent:!0,opacity:.4,attribution:"GBA"}),y=new e.tileLayer.wms("http://gisgba.geologie.ac.at/arcgis/services/image/AT_GBA_GK50/ImageServer/WMSServer",{layers:"0",version:"1.3.0",format:"image/png",transparent:!0,opacity:.4,attribution:"GBA"});l=new e.geoJson([],{position:"front",pointToLayer:h,onEachFeature:d}),l.addTo(t);var _="http://193.170.253.69/arcgis/rest/services/dataviewer/AT_GBA_DATAVIEWER/MapServer";c=new i(_,{opacity:.4,layers:[2],layerDefs:{2:"GBANR LIKE '1387.0037.0830'"}}),u=new i(_,{opacity:.4,layers:[1],layerDefs:{1:"GBANR LIKE '1387.0037.0830'"}});var T=e.layerGroup([c,u]);t.addLayer(T);var I={"MK 500":w,"GK 50":y,"BaseMap.at":b},L={"selected points":l,"selected polygons":T};e.control.layers(I,L,{collapsed:!0}).addTo(t)};var d=function(t,r){var i;if(t.properties){var o="<ul class='identifyList'>";for(var n in t.properties)if(t.properties.hasOwnProperty(n)){var a=t.properties[n];if(null===a||"Null"===a||""===a||"System.Byte[]"===a)continue;if("PROPORTION"===n){var s='<svg height="10" width="8"><circle cx="4" cy="4" r="3" stroke="#CC0000" stroke-width="1" fill="'+g(t)+'" /></svg>',l=n.charAt(0).toUpperCase()+n.substr(1).toLowerCase();o+="<li>"+s+" <b>"+l+": </b>"+a+"</li>"}else o+="<li>"+a+"</li>"}o+="</ul>",i=r.bindPopup(o)}!function(t,r,i){t.on("click",function(t){f(t),e.DomEvent.stopPropagation(t)}),i.on("popupclose",function(t){m(t),e.DomEvent.stopPropagation(t)})}(r,t.properties,i)},f=function(e){var t=e.target,r={color:"#2262CC",weight:7,opacity:1};t.setStyle(r)},m=function(e){var t=e.target,r=e.target.feature,i={radius:3,color:"#CC0000",weight:1,opacity:1,fillColor:g(r),fillOpacity:v(r)};t.setStyle(i)},h=function(t,r){var i={radius:3,color:"#CC0000",weight:1,opacity:1,fillColor:g(t),fillOpacity:v(t)};return e.circleMarker(r,i)},g=function(e){return"all"===e.properties.PROPORTION||"most abundant"===e.properties.PROPORTION?"#FF4444":null===e.properties.PROPORTION||void 0===e.properties.PROPORTION?"#FF4444":"#FFFFFF"},v=function(e){return"all"===e.properties.PROPORTION||"most abundant"===e.properties.PROPORTION?.8:null===e.properties.PROPORTION||void 0===e.properties.PROPORTION?.8:0};p.showL_ID=function(e,i,o,n){if(l.clearLayers(),null!==p.LID_XHR&&p.LID_XHR.abort(),null!==p.LID_POLY_XHR&&p.LID_POLY_XHR.abort(),null!==p.LID_POLY_XHR2&&p.LID_POLY_XHR2.abort(),0===e.length)return t.info("No filters!!!",!0),void(void 0!==n&&n());var a=r.map(e,function(e){return e.l_id}),s="GBANR IN ('"+a.join("','")+"')";a.length>160?b(e,s).done(function(){void 0!==o&&o()}).fail(function(){void 0!==n&&n()}):r.when(b(e,s),w(e,s,i)).done(function(){void 0!==o&&o()}).fail(function(){void 0!==n&&n()})};var b=function(e,t){var i=r.Deferred();return c.setLayerDefs({2:t}),u.setLayerDefs({1:t}),i.resolve("success"),i.promise()},w=function(e,i,o){var n=r.Deferred();return a.request("http://gisgba.geologie.ac.at/arcgis/rest/services/dataviewer/AT_GBA_DATAVIEWER/MapServer/0/query",{f:"json",inSR:31287,outSR:4326,geometryType:"esriGeometryMultipoint",geometryPrecision:15,where:i,outFields:"C01.GBA.DATAVIEWER.GBANR,C01.gba.GE_GeologicFeature.LEGTEXT"},function(i,a){if(i)"abort"!==i.message&&t.error(i.message+": points couldn't be loaded222",!0),n.reject("point request error: "+i.message);else if(a.error)t.error(a.error.details[0],!0),n.reject(a.error.details[0]);else if(a.features.length>0){for(var s=0;s<a.features.length;s++)for(var l=a.features[s],u=0;u<l.geometry.points.length;u++){l.geometry.points[u]}if(!0===o)for(var c=0;c<a.features.length;c++){var l=a.features[c],p=l.attributes["C01.GBA.gk50v1_DATAVIEWER_P.GBANR"],d=r.grep(e,function(e){return e.l_id===p});d.length>0&&(l.attributes.PROPORTION=d[0].proportion)}y(a,0),n.resolve(a)}else t.warning("Correct request, but the rest service responds no point features.",!0),n.reject("Correct request, but the rest service responds no point features.")},this),n.promise()},y=function(e){var t=_(e);null!==t&&l.addData(t)},_=function(e,t){function r(e){for(var t=[],r=[],o=e.length,n=0;o>n;)i(e[n])?t.push(e[n]):r.push(e[n]),n++;return[t,r]}function i(e){for(var t=e.length-1,r=0,i=0;t>r;)i+=e[r][0]*e[r+1][1]-e[r+1][0]*e[r][1],r++;return i<=0}for(var o={type:"FeatureCollection",features:[]},n=e.features.length,a=0;n>a;){var s=e.features[a],l={type:"Feature",properties:s.attributes};s.geometry.x?l.geometry=function(e){return{type:"Point",coordinates:[e.x,e.y]}}(s.geometry):s.geometry.points?l.geometry=function(e){return 1===e.points.length?{type:"Point",coordinates:e.points[0]}:{type:"MultiPoint",coordinates:e.points}}(s.geometry):s.geometry.paths?l.geometry=function(e){return 1===e.paths.length?{type:"LineString",coordinates:e.paths[0]}:{type:"MultiLineString",coordinates:e.paths}}(s.geometry):s.geometry.rings&&(l.geometry=function(e){if(1===e.rings.length)return{type:"Polygon",coordinates:e.rings};var t=r(e.rings),i=t[0],o=t[1],n=[];if(0===o.length){for(var a=i.length;a>0;)n.push([i[0]]);return{type:"MultiPolygon",coordinates:n}}return 1===i.length?(o.unshift(i[0]),{type:"Polygon",coordinates:o}):{type:"MultiPolygon",coordinates:i,holes:o}}(s.geometry)),o.features.push(l),a++}if(!t)return o;t(o)}}}),define("nls/template",{root:{viewer:{main:{scaleBarUnits:"metric",otherLng:"de",otherLngImg:"../content/img/at.png"},terms:{narrower:"narrower concepts",activeNarrower:"including narrower concepts",broader:"broader concepts",activeBroader:"including broader concepts",related:"related concepts",activeRelated:"including related concepts",filter:"restricted to"},sidePanel:{title:"Refine by",collapse:"collapse",more:"all terms.."},footer:{actualYear:"&#169; "+(new Date).getFullYear()+" GBA",contact:"Contact",accessConstraints:"Terms of use",disclaimer:"Disclaimer"},buttons:{btnClearFilter:"Clear"},messages:{waitMessage:"Please wait...",featuresTagged:"Geologic Features tagged with",pointsPartially:"(partially shown in the map)"}},red:"red",blue:"blue",green:"green"},de:!0}),define("viewmodel/FilterViewModel",["jquery","ko","helper/logger","i18n!nls/template"],function(e,t,r,i){return function(e,o,n,a){var s=this;s.name=e,s.localizedName=o,s.dataservice=a.dataservice,s.filterItems=t.observableArray(n),s.filterListViewModel=a,s.activeFilterItems=t.computed(function(){for(var e=[],t=s.filterItems(),r=0;r<t.length;++r){t[r].isItemActive()&&(e[e.length]=t[r])}return e}),s.itemLabel=function(e){return e.name},s.itemLabel2=function(e){var t=" ("+e.l_id2.length+") ";return null!==e.uri&&(null!==e.description?t+="<a href='"+e.uri+"' target='_blank' title='"+e.description+"' class='tooltip'> Info<a>":t+="<a href='"+e.uri+"' target='_blank' class='tooltip'> Info<a>"),t},s.activateItem=function(e){e.setActive(),s.dataservice.getNarrowerTerms(e.uri,e.endpoint).then(function(e){if(e.length<=0)return s.filterListViewModel.activeFilterViewModelItems.push(s),void s.dataservice.refreshFilterViewModelItems(s.filterListViewModel,function(){s.filterListViewModel.refreshMap()},function(){});for(var t=e,r=s.filterItems(),i=0;i<r.length;i++)for(var o=r[i],n=0;n<t.length;n++){var a=t[n];a.uri===o.uri&&o.setActive()}s.filterListViewModel.activeFilterViewModelItems.push(s),s.dataservice.refreshFilterViewModelItems(s.filterListViewModel,function(){s.filterListViewModel.refreshMap()},function(){})}).fail(function(e){r.error("Recursive narrower concepts couldn't be queried: "+e,!0)})},s.overflowing=t.computed(function(){return s.filterItems().length>5}),s.collapsed=t.observable(!0),s.uncollapseLabelText=t.computed(function(){return!0===s.collapsed()?i.viewer.sidePanel.more:i.viewer.sidePanel.collapse}),s.toggle=function(){!0===s.collapsed()?s.collapsed(!1):!1===s.collapsed()&&s.collapsed(!0)}}}),define("viewmodel/model",["ko"],function(e){var t=function(t){return t.selected=e.observable(!1),t.toggle=function(){t.selected(!t.selected())},t.isItemActive=e.observable(!1),t.setActive=function(){t.isItemActive(!0)},t.uriWithLang=e.computed(function(){return t.uri+"&lang="+t.lang}),t.idLabel=e.computed(function(){for(var e="",r=0;r<t.l_id2.length;r++)e+=t.l_id2[r].l_id+"; ";return e}),t},r=function(t){return t.isTermActive=e.observable(!0),t.setInActive=function(){t.isTermActive(!1)},t.uriWithLang=e.computed(function(){return t.uri+"&lang="+t.lang}),t};return{FilterItem:function(e){return t(e)},ThesaurusTerm:function(e){return r(e)}}}),define("helper/utilities",["jquery","i18n!nls/template"],function(e,t){return{setLoading:function(r){var i="loading__"+r,o=e("#"+i);if(o.length>0)void 0===o.attr("lock")?o.attr("lock",1):o.attr("lock",parseInt(o.attr("lock"))+1);else{var n=e('<div id="'+i+'" class="loading"></div>'),a=e('<div class="loading-content">'+t.viewer.messages.waitMessage+"</div>");n.append(a);var s=e("#"+r),l=s.offset(),u=s.outerWidth(),c=s.outerHeight();n.css({left:l.left,top:l.top,width:u+"px",height:c+"px"}),a.css({"line-height":c+"px"}),e("body").append(n)}},unsetLoading:function(t){var r=e("#loading__"+t),i=r.attr("lock");if(void 0===i)r.remove();else{var o=parseInt(i);o>1?r.attr("lock",o-1):r.removeAttr("lock")}}}}),define("app/dataservice",["jquery","helper/logger","viewmodel/FilterViewModel","viewmodel/model","helper/utilities"],function(e,t,r,i,o){return function(n,a){var s=this;s.StartUri=n,s.Lang=a,s.StartConcept,s.Result={},s.EndpointUri,s.primeData=function(){return e.when(u(),c())};var l=function(e){var t=s.StartUri;if(e.narrower()&&e.narrowerTerms())for(var r=0;r<e.narrowerTerms().length;r++){var i=e.narrowerTerms()[r];t+=","+i.uri}if(e.broader()&&e.broaderTerms())for(var o=0;o<e.broaderTerms().length;o++){var n=e.broaderTerms()[o];t+=","+n.uri}if(e.related()&&e.relatedTerms())for(var a=0;a<e.relatedTerms().length;a++){var l=e.relatedTerms()[a];t+=","+l.uri}return t};s.refreshFilterViewModelItems=function(n,a,u){function c(e){for(var t=[],l=0;l<e.Filters.length;++l){var u=e[e.Filters[l].name],c=[];u.forEach(function(e){e.lang=s.Lang,c.push(new i.FilterItem(e))});for(var p=new r(e.Filters[l].name,e.Filters[l].localizedName,c,n),d=!1,f=n.activeFilterViewModelItems(),m=0;m!==f.length;++m)f[m].name===p.name&&(d=!0);d||t.push(p)}n.filterViewModelItems(t),n.allLIDs(e.L_ID),n.notIncludedUris(e.NotIncludedUris),o.unsetLoading("left-bar"),void 0!==a&&a()}function p(e){t.error("DB query failed: "+e.statusText,!0),o.unsetLoading("left-bar"),void 0!==u&&u()}o.setLoading("left-bar");var d=l(n),f=n.narrowerTerms().concat(n.broaderTerms()).concat(n.relatedTerms());f.unshift(s.StartConcept);for(var m,h=f.map(function(e){return e.uri}).join(","),g=[],v=[],b=[],w=[],y=[],_=[],T=[],I=[],L=n.activeFilterViewModelItems(),O=0;O<L.length;O++){var R,A,D=L[O],x=D.activeFilterItems();if("TectonicUnit"===D.name)for(R=0;R<x.length;R++)A=x[R],g.push(A.uri);if("GeologicUnit"===D.name)for(R=0;R<x.length;R++)A=x[R],v.push(A.uri);if("Proportion"===D.name)for(R=0;R<x.length;R++)A=x[R],b.push(A.uri);if("TimeScale"===D.name)for(R=0;R<x.length;R++)A=x[R],w.push(A.uri);if("Dataset"===D.name&&(m=x[0].name),"Lithology"===D.name)for(R=0;R<x.length;R++)A=x[R],y.push(A.uri);if("EventProcess"===D.name)for(R=0;R<x.length;R++)A=x[R],_.push(A.uri);if("EventEnvironment"===D.name)for(R=0;R<x.length;R++)A=x[R],T.push(A.uri);if("DescriptionPurpose"===D.name)for(R=0;R<x.length;R++)A=x[R],I.push(A.uri)}var P={tectonicuris:g,geologicunituris:v,proportionuris:b,timescaleuris:w,dataset:m,lithologyuris:y,eventprocessuris:_,eventenvironmenturis:T,descriptionpurposeuris:I},E=JSON.stringify(P,null,2);e.ajax({url:"../tdv/AttributeHandler.ashx",type:"POST",data:{topics:d,alltopics:h,filters:E,uri:s.StartUri,language:s.Lang},dataType:"json"}).done(c).fail(p)},s.getFilterViewModelItems=function(i,o,n,a,l,u,c){function p(e){for(var t=[],o=0;o<e.Filters.length;++o){[];for(var n=0;n<e[e.Filters[o].name].length;++n)e[e.Filters[o].name][n].FilterID=o;t[o]=new r(e.Filters[o].name,e.Filters[o].localizedName,e[e.Filters[o].name],i)}i.filterViewModelItems(t),i.allLIDs(e.L_ID)}function d(e){t.error("DB query failed: "+e.statusText,!0)}var f=s.StartUri;if(l&&o)for(var m=0;m<o.length;m++){var h=o[m];f+=","+h.uri}if(u&&n)for(var g=0;g<n.length;g++){var v=n[g];f+=","+v.uri}if(c&&a)for(var b=0;b<a.length;b++){var w=a[b];f+=","+w.uri}e.ajax({url:"../tdv/AttributeHandler.ashx",type:"POST",data:{topics:f,uri:s.StartUri,language:""},dataType:"json"}).done(p).fail(d)},s.getNarrowerTerms=function(t,r){function i(e){for(var r=e.results.bindings,i=0;i<r.length;i++){var o=r[i];t!==o.URI.value&&s.push({name:o.prefLabel.value,uri:o.URI.value})}n.resolve(s)}function o(e,t,r){n.reject(r)}var n=e.Deferred();if(null===r||""===r)return n.resolve([]),n;var a="            PREFIX skos:<http://www.w3.org/2004/02/skos/core#>             select ?URI ?prefLabel             where {                 <"+t+"> skos:narrower* ?URI .                   ?URI skos:prefLabel ?prefLabel . FILTER ( lang(?prefLabel) = 'en' )               }",s=[];return e.ajax({type:"POST",dataType:"json",url:r,data:{query:a,format:"application/json"}}).done(i).fail(o),n.promise()};var u=function(){function t(t){s.Result={broader:[],narrower:[],related:[]},e(t).find("result").each(function(){var t=e(this).find("binding[name='type']").find("literal").text(),r=e(this).find("binding[name='prefLabel']").find("literal").text(),o=e(this).find("uri").text();if(s.StartUri!==o){var n=new i.ThesaurusTerm({name:r,uri:o,lang:s.Lang});s.Result[t].push(n)}else s.StartConcept=new i.ThesaurusTerm({name:r,uri:o,lang:s.Lang})}),o.resolve()}function r(e){o.reject(e)}var o=e.Deferred();return s.EndpointUri=p(s.StartUri),e.ajax({type:"GET",url:s.EndpointUri,data:{format:"application/xml",query:'PREFIX skos:<http://www.w3.org/2004/02/skos/core#> SELECT ?URI ?prefLabel ?type {{SELECT DISTINCT ?URI ?prefLabel ("broader" AS ?type) WHERE {{<'+s.StartUri+"> skos:broader ?URI } ?URI skos:prefLabel ?prefLabel . FILTER ( lang(?prefLabel) ='"+s.Lang+'\' )}} UNION { SELECT DISTINCT ?URI ?prefLabel ("narrower" AS ?type) WHERE {<'+s.StartUri+"> skos:narrower* ?URI . ?URI skos:prefLabel ?prefLabel . FILTER ( lang(?prefLabel) ='"+s.Lang+'\' ) }} UNION {SELECT DISTINCT ?URI ?prefLabel ("related" AS ?type) WHERE {{<'+s.StartUri+"> skos:related ?URI } ?URI skos:prefLabel ?prefLabel . FILTER ( lang(?prefLabel) ='"+s.Lang+"' )}}}"},cache:!1,dataType:"xml"}).done(t).fail(r),o.promise()},c=function(){var t=e.Deferred(),r=document.getElementsByTagName("html")[0];return""===document.body.style.direction?r.setAttribute("dir","ltr"):r.setAttribute("dir","rtl"),t.resolve(!0),t.promise},p=function(e){if(null===e)return"";var t=e,r=t.lastIndexOf("/"),i=t.substring(0,r+1),o="";switch(i){case"http://resource.geolba.ac.at/GeologicUnit/":o="http://resource.geolba.ac.at/PoolParty/sparql/GeologicUnit";break;case"http://resource.geolba.ac.at/tectonicunit/":o="http://resource.geolba.ac.at/PoolParty/sparql/tectonicunit";break;case"http://resource.geolba.ac.at/lithology/":o="http://resource.geolba.ac.at/PoolParty/sparql/lithology";break;case"http://resource.geolba.ac.at/GeologicTimeScale/":o="http://resource.geolba.ac.at/PoolParty/sparql/GeologicTimeScale";break;default:o=""}return o}}}),define("viewmodel/FilterListViewModel",["ko","app/dataservice","helper/utilities","helper/logger","i18n!nls/template"],function(e,t,r,i,o){return function(t,n,a){var s=this;s.startUri=a,s.dataservice=t,s.filterViewModelItems=e.observableArray([]),s.activeFilterViewModelItems=e.observableArray([]),s.notIncludedUris=e.observableArray([]),s.allLIDs=e.observableArray([]),s.narrower=e.observable(!0),s.broader=e.observable(!1),s.related=e.observable(!1),s.narrower.subscribe(function(e){i.info("Narrower: "+e,!0),l()}),s.broader.subscribe(function(e){i.info("Broader: "+e,!0),l()}),s.related.subscribe(function(e){i.info("Related: "+e,!0),l()}),s.narrowerTerms=e.observableArray(t.Result.narrower),s.broaderTerms=e.observableArray(t.Result.broader),s.relatedTerms=e.observableArray(t.Result.related);var l=function(){s.activeFilterViewModelItems.removeAll(),s.makeAllTermsActive(),s.dataservice.refreshFilterViewModelItems(s,function(){n.setHomeExtent(),s.refreshMap()},function(){})};s.notIncludedUris.subscribe(function(){var e=s.notIncludedUris();if(e.length>0){e.indexOf(t.StartConcept.uri)>-1&&t.StartConcept.isTermActive(!1);var r;for(r=0;r<s.narrowerTerms().length;r++){var i=s.narrowerTerms()[r];e.indexOf(i.uri)>-1&&i.isTermActive(!1)}for(r=0;r<s.broaderTerms().length;r++){var o=s.broaderTerms()[r];e.indexOf(o.uri)>-1&&o.isTermActive(!1)}for(r=0;r<s.relatedTerms().length;r++){var n=s.relatedTerms()[r];e.indexOf(n.uri)>-1&&n.isTermActive(!1)}s.narrower()&&s.narrowerTerms.sort(function(e,t){return e.isTermActive()===t.isTermActive()?0:e.isTermActive()?-1:1}),s.broader()&&s.broaderTerms.sort(function(e,t){return e.isTermActive()===t.isTermActive()?0:e.isTermActive()?-1:1}),s.related()&&s.relatedTerms.sort(function(e,t){return e.isTermActive()===t.isTermActive()?0:e.isTermActive()?-1:1})}}),s.makeAllTermsActive=function(){t.StartConcept.isTermActive(!0);var e;for(e=0;e<s.narrowerTerms().length;e++){s.narrowerTerms()[e].isTermActive(!0)}for(e=0;e<s.broaderTerms().length;e++){s.broaderTerms()[e].isTermActive(!0)}for(e=0;e<s.relatedTerms().length;e++){s.relatedTerms()[e].isTermActive(!0)}},s.labels=o,s.changeLanguage=function(){localStorage.setItem("tdv-locale",o.viewer.main.otherLng),location.reload()};var u=!1;s.initialize=function(e,t){u||(u=!0,s.dataservice.refreshFilterViewModelItems(s,function(){s.refreshMap(),void 0!==e&&e()},function(){void 0!==t&&t()}))},s.formatTermURL=function(e){return"?url="+e.uriWithLang()},s.formatFilterTermURL=function(e){return""===e.endpoint?null:"?url="+e.uriWithLang()},s.isGbaTerm=function(e){return""!==e.endpoint},s.hasActiveRelatedTerms=e.computed(function(){for(var e=0;e<s.relatedTerms().length;e++){if(s.relatedTerms()[e].isTermActive())return!0}return!1}),s.hasActiveNarrowerTerms=e.computed(function(){for(var e=0;e<s.narrowerTerms().length;e++){if(s.narrowerTerms()[e].isTermActive())return!0}return!1}),s.hasActiveBroaderTerms=e.computed(function(){for(var e=0;e<s.broaderTerms().length;e++){if(s.broaderTerms()[e].isTermActive())return!0}return!1}),s.lidCountLabel=e.computed(function(){return s.allLIDs().length+" "+o.viewer.messages.featuresTagged}),s.inactivateFilterViewModelItem=function(){s.activeFilterViewModelItems([]),s.makeAllTermsActive(),s.dataservice.refreshFilterViewModelItems(s,function(){n.setHomeExtent(),s.refreshMap()},function(){})},s.refreshMap=function(){var e,t=s.allLIDs();e=s.startUri.indexOf("lithology")>-1,r.setLoading("map"),n.showL_ID(t,e,function(){r.unsetLoading("map")},function(){r.unsetLoading("map")})}}}),define("app/app",["jquery","helper/logger","app/map2","app/dataservice","viewmodel/FilterListViewModel","ko"],function(e,t,r,i,o,n){var a=function(e,t){var r=new RegExp("[\\?&]"+e+"=([^&#]*)").exec(t);return null===r?null:r[1]||0};return{init:function(e){function s(){var e=new r("map");e.init();var i=new o(m,e,c);n.applyBindings(i),i.initialize(function(){t.success("DataViewer successfully loaded!",!0)},function(){t.error("Filter konnten nicht intialisiert werden!",!0)})}function l(e){t.error("App initialization failed: "+e.statusText,!0)}var u=window.location.href,c=a("url",u);if(void 0===c||null===c)t.error("App initialization failed: no uri parameter",!0);else{var p=window._gaq=window._gaq||[];p.push(["_setAccount","UA-36825195-1"]),p.push(["_trackPageview"]);var d=document.createElement("script");d.type="text/javascript",d.async=!0,d.src=("https:"===document.location.protocol?"https://ssl":"http://www")+".google-analytics.com/ga.js";var f=document.getElementsByTagName("script")[0];f.parentNode.insertBefore(d,f);var m=new i(c,e);m.primeData().then(s).fail(l)}}}}),define("main",["app/app","jquery"],function(e,t){var r=requirejs.s.contexts._.config.locale;t(document).ready(function(){e.init(r)})}),require.config({paths:{jquery:"jquery",toastr:"toastr",ko:"ko",leaflet:"leaflet",text:"text",i18n:"i18n"},urlArgs:"version=release2",shim:{toastr:{deps:["jquery"],exports:"toastr"},leaflet:{exports:"L"}}}),requirejs.s.contexts._.config.locale=_urlParam("lang",window.location.href)?_urlParam("lang",window.location.href):"en",require(["main"]),define("buildconfig",function(){}),define("nls/de/template",{viewer:{main:{
scaleBarUnits:"english",otherLng:"en",otherLngImg:"../content/img/gb.png"},terms:{narrower:"untergeordnete Begriffe",activeNarrower:"inkl. untergeordnete Begriffe",broader:"übergeordnete Begriffe",activeBroader:"inkl. übergeordnete Begriffe",related:"verwandte Begriffe",activeRelated:"inkl. verwandte Begriffe",filter:"eingeschränkt auf"},sidePanel:{title:"Filter nach",collapse:"Ausblenden",more:"alle Begriffe.."},footer:{actualYear:"&#169; "+(new Date).getFullYear()+" GBA",contact:"Kontakt",accessConstraints:"Nutzungsbedingungen",disclaimer:"Haftungsausschluss"},buttons:{btnClearFilter:"Löschen"},messages:{waitMessage:"Bitte warten...",featuresTagged:"Einheiten im Zusammenhang mit",pointsPartially:"(teilweise in der Karte dargestellt)"}},red:"rot",blue:"blau",green:"grün"});